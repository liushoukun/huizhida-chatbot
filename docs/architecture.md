# æ±‡æ™ºç­”-æ™ºèƒ½å®¢æœå¹³å°


## 2. é¡¹ç›®æ¦‚è¿°

### 2.1 é¡¹ç›®èƒŒæ™¯

éšç€ä¼ä¸šå¤šæ¸ é“è¿è¥çš„æ™®åŠï¼Œå®¢æˆ·æœåŠ¡éœ€è¦åŒæ—¶å¯¹æ¥ä¼ä¸šå¾®ä¿¡ã€æ·˜å®ã€æŠ–éŸ³ç­‰å¤šä¸ªå¹³å°ã€‚å„å¹³å°æ¶ˆæ¯æ ¼å¼ã€APIæ¥å£å„ä¸ç›¸åŒï¼ŒåŒæ—¶ä¼ä¸šå¸Œæœ›åˆ©ç”¨AIæ™ºèƒ½ä½“æ¥æå‡å®¢æœæ•ˆç‡ã€‚

**æ±‡æ™ºç­”** æ—¨åœ¨æ„å»ºä¸€ä¸ªç»Ÿä¸€çš„æ™ºèƒ½å®¢æœä¸­æ¢å¹³å°ï¼Œå®ç°å¤šå¹³å°æ¶ˆæ¯çš„ç»Ÿä¸€æ¥å…¥ã€æ™ºèƒ½å¤„ç†å’Œè‡ªåŠ¨å›å¤ã€‚

> **æ±‡æ™ºç­”** = **æ±‡**èš + **æ™º**èƒ½ + åº”**ç­”**
>
> æ±‡èšæ™ºèƒ½ï¼Œæœ‰é—®å¿…ç­”

### 2.2 é¡¹ç›®ç›®æ ‡

1. **ç»Ÿä¸€æ¥å…¥**ï¼šå¯¹æ¥å¤šä¸ªä¸»æµå®¢æœæ¸ é“ï¼Œå°†ä¸åŒæ ¼å¼çš„æ¶ˆæ¯è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
2. **æ™ºèƒ½å¤„ç†**ï¼šé›†æˆå¤šç§AIæ™ºèƒ½ä½“å¹³å°ï¼Œå®ç°æ™ºèƒ½è‡ªåŠ¨å›å¤
3. **çµæ´»æ‰©å±•**ï¼šé‡‡ç”¨æ’ä»¶åŒ–æ¶æ„ï¼Œæ–¹ä¾¿æ‰©å±•æ–°çš„å¹³å°å’Œæ™ºèƒ½ä½“
4. **äººæœºåä½œ**ï¼šæ”¯æŒæ™ºèƒ½ä½“ä¸äººå·¥å®¢æœæ— ç¼åˆ‡æ¢
5. **å¯è§†åŒ–ç®¡ç†**ï¼šæä¾›ç®¡ç†åå°è¿›è¡Œé…ç½®å’Œç›‘æ§

### 2.3 æœ¯è¯­å®šä¹‰

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| æ¸ é“(Channel) | å®¢æœæ¶ˆæ¯æ¥æºæ¸ é“ï¼Œå¦‚ä¼ä¸šå¾®ä¿¡ã€æ·˜å®ç­‰ |
| æ™ºèƒ½ä½“(Agent) | AIå¯¹è¯å¤„ç†å¼•æ“ï¼Œå®ç°ç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒå¤šç§AIå¹³å° |
| æ™ºèƒ½ä½“é€‚é…å™¨(Agent Adapter) | æ™ºèƒ½ä½“çš„ç»Ÿä¸€æŠ½è±¡æ¥å£ï¼Œæ‰€æœ‰æ™ºèƒ½ä½“å®ç°éƒ½éµå¾ªæ­¤æ¥å£ |
| æ¶ˆæ¯å¤„ç†å¼•æ“(Engine) | æ ¸å¿ƒå¤„ç†ç»„ä»¶ï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±å’Œæ™ºèƒ½ä½“è°ƒç”¨ |
| æ¶ˆæ¯(Message) | ç”¨æˆ·æˆ–ç³»ç»Ÿå‘é€çš„å•æ¡é€šä¿¡å†…å®¹ï¼ŒåŒ…å«æ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ç­‰ç±»å‹ |
| å¯¹è¯(Chat) | ä¸€æ¬¡æ¶ˆæ¯çš„è¯·æ±‚ä¸å“åº”äº¤äº’è¿‡ç¨‹ |
| ä¼šè¯(Conversation) | ç”¨æˆ·ä¸å®¢æœä¹‹é—´çš„ä¸€æ¬¡å®Œæ•´å¯¹è¯è¿‡ç¨‹ï¼ŒåŒ…å«å¤šæ¬¡å¯¹è¯ |
| åº”ç”¨(Application) | ä¸€ä¸ªç‹¬ç«‹çš„å®¢æœæœåŠ¡å®ä¾‹ï¼Œå¯é…ç½®å¤šä¸ªæ¸ é“ï¼Œæ¯ä¸ªæ¸ é“å¯ç»‘å®šä¸åŒçš„æ™ºèƒ½ä½“ |
| å›è°ƒ(Callback) | æ¸ é“ä¸»åŠ¨æ¨é€æ¶ˆæ¯åˆ°æœ¬ç³»ç»Ÿçš„æ¥å£ |

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

ç³»ç»Ÿé‡‡ç”¨ **ä¸‰å±‚æ¶æ„ + åŒé˜Ÿåˆ—é©±åŠ¨** æ¨¡å¼ï¼Œé€šè¿‡ `inputs` å’Œ `outputs` ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å®ç°å±‚ä¸å±‚ä¹‹é—´çš„è§£è€¦ï¼š

```mermaid
flowchart TB
    subgraph Layer1["1ï¸âƒ£ æ¸ é“æ¥å…¥å±‚"]
        direction LR
        WeChat["ä¼ä¸šå¾®ä¿¡"] ~~~ Taobao["æ·˜å®"] ~~~ Douyin["æŠ–éŸ³"] ~~~ OtherChannel["å…¶ä»–æ¸ é“..."]
    end

    subgraph Layer2["2ï¸âƒ£ æ¶ˆæ¯å¤„ç†å¼•æ“"]
        direction LR
        InputsQueue[["ğŸ“¥ inputs"]] --> Engine["âš™ï¸ Engine"] --> OutputsQueue[["ğŸ“¤ outputs"]]
    end

    subgraph Layer3["3ï¸âƒ£ æ™ºèƒ½ä½“æ¥å…¥å±‚"]
        direction LR
        OpenAI["OpenAI"] ~~~ Qwen["é€šä¹‰åƒé—®"] ~~~ Coze["Coze"] ~~~ Dify["Dify"] ~~~ OtherAI["å…¶ä»–å¹³å°..."]
    end

    Layer1 <-->|"æ¶ˆæ¯æ”¶å‘"| Layer2
    Layer2 <-->|"æ™ºèƒ½ä½“è°ƒç”¨"| Layer3
```

### 3.2 èŒè´£åˆ’åˆ†

| å±‚çº§ | æ ¸å¿ƒèŒè´£ |
|------|----------|
| **æ¸ é“æ¥å…¥å±‚ (Channel)** | å¯¹æ¥å„å®¢æœæ¸ é“ï¼ˆä¼ä¸šå¾®ä¿¡ã€æ·˜å®ã€æŠ–éŸ³ç­‰ï¼‰ï¼Œè´Ÿè´£æ¸ é“å›è°ƒæ¥æ”¶ã€ç­¾åéªŒè¯ã€æ¶ˆæ¯æ ¼å¼è½¬æ¢ã€æ¶ˆæ¯å…¥é˜Ÿ (inputs)ã€æ¶ˆè´¹è¾“å‡ºé˜Ÿåˆ— (outputs)ã€æ¶ˆæ¯å‘é€ |
| **æ¶ˆæ¯å¤„ç†å¼•æ“ (Engine)** | æ ¸å¿ƒå¤„ç†å±‚ï¼Œæ¶ˆè´¹ inputs é˜Ÿåˆ—ã€äº‹ä»¶å¤„ç†ã€è§„åˆ™é¢„æ ¡éªŒã€è°ƒç”¨æ™ºèƒ½ä½“ã€å›å¤é¢„å¤„ç†ã€å‘å¸ƒåˆ° outputs é˜Ÿåˆ— |
| **æ™ºèƒ½ä½“æ¥å…¥å±‚ (Agent)** | å¯¹æ¥å„ AI å¹³å°ï¼ˆOpenAIã€é€šä¹‰åƒé—®ã€Cozeã€Dify ç­‰ï¼‰ï¼Œæä¾›ç»Ÿä¸€çš„æ™ºèƒ½ä½“é€‚é…å™¨æ¥å£ |
| **ç®¡ç†ç«¯ (Admin)** | åº”ç”¨ç®¡ç†ã€æ¸ é“é…ç½®ã€æ™ºèƒ½ä½“é…ç½®ã€æ•°æ®ç»Ÿè®¡ã€ç³»ç»Ÿç›‘æ§ |

**åŒé˜Ÿåˆ—è¯´æ˜**ï¼š

| é˜Ÿåˆ— | æ–¹å‘ | ä½œç”¨ |
|------|------|------|
| `inputs` | æ¸ é“å±‚ â†’ å¼•æ“å±‚ | ä¼ é€’ç”¨æˆ·è¾“å…¥æ¶ˆæ¯ï¼Œè§¦å‘æ¶ˆæ¯å¤„ç† |
| `outputs` | å¼•æ“å±‚ â†’ æ¸ é“å±‚ | ä¼ é€’æ™ºèƒ½ä½“å›å¤ï¼Œè§¦å‘æ¶ˆæ¯å‘é€ |

### 3.3 æ ¸å¿ƒå¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant C as å®¢æœæ¸ é“
    participant CH as æ¸ é“æ¥å…¥å±‚
    participant IQ as inputsé˜Ÿåˆ—
    participant E as æ¶ˆæ¯å¤„ç†å¼•æ“
    participant A as æ™ºèƒ½ä½“æ¥å…¥å±‚
    participant OQ as outputsé˜Ÿåˆ—

    Note over C,OQ: 1ï¸âƒ£ å…¥ç«™æµç¨‹
    C->>CH: 1. æ¸ é“å›è°ƒæ¶ˆæ¯
    CH->>CH: 2. éªŒç­¾ + æ ¼å¼è½¬æ¢
    CH->>IQ: 3. å‘å¸ƒåˆ° inputs é˜Ÿåˆ—
    CH-->>C: 4. å¿«é€Ÿå“åº”

    Note over C,OQ: 2ï¸âƒ£ æ¶ˆæ¯å¤„ç†æµç¨‹
    IQ->>E: 5. æ¶ˆè´¹ inputs æ¶ˆæ¯
    E->>E: 6. é˜²æŠ–å¤„ç†ï¼ˆèšåˆåŒä¸€ä¼šè¯çš„è¿ç»­æ¶ˆæ¯ï¼‰
    E->>E: 7. äº‹ä»¶å¤„ç† + è§„åˆ™é¢„æ ¡éªŒ
    
    alt è§„åˆ™å‘½ä¸­è½¬äººå·¥ï¼ˆå…³é”®è¯/VIPç­–ç•¥ç­‰ï¼‰
        E->>OQ: 8a. å‘å¸ƒè½¬äººå·¥äº‹ä»¶åˆ° outputs
    else æ­£å¸¸å¤„ç†
        E->>A: 8b. è°ƒç”¨æ™ºèƒ½ä½“
        A->>A: 9. æ™ºèƒ½ä½“é€‚é…å™¨å¤„ç†
        A-->>E: 10. è¿”å›æ™ºèƒ½ä½“å›å¤
        E->>E: 11. å›å¤é¢„å¤„ç†
        E->>OQ: 12. å‘å¸ƒåˆ° outputs é˜Ÿåˆ—
    end

    Note over C,OQ: 3ï¸âƒ£ å‡ºç«™æµç¨‹
    OQ->>CH: 13. æ¶ˆè´¹ outputs æ¶ˆæ¯
    CH->>C: 14. å‘é€æ¶ˆæ¯åˆ°æ¸ é“
```

### 3.5 æ ¸å¿ƒæ•°æ®ç»“æ„å®šä¹‰

#### 3.4.1 é˜Ÿåˆ—å®šä¹‰

| é˜Ÿåˆ—å | æ–¹å‘ | è¯´æ˜ |
|--------|------|------|
| `conversations:queue:inputs` | æ¸ é“æ¥å…¥å±‚ â†’ æ¶ˆæ¯å¤„ç†å¼•æ“ | è¾“å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œè§¦å‘æ¶ˆæ¯å¤„ç†ï¼ˆæ”¯æŒå»¶æ—¶ï¼Œç”¨äºé˜²æŠ–ï¼‰ |
| `conversations:queue:outputs` | æ¶ˆæ¯å¤„ç†å¼•æ“ â†’ æ¸ é“æ¥å…¥å±‚ | è¾“å‡ºäº‹ä»¶é˜Ÿåˆ—ï¼ŒåŒ…å«å›å¤/è½¬äººå·¥/çŠ¶æ€å˜æ›´æ¶ˆæ¯ |
| `conversations:queue:callback` | æ¸ é“æ¥å…¥å±‚ â†’ æ¶ˆæ¯å¤„ç†å¼•æ“ | å›è°ƒå¤„ç†é˜Ÿåˆ— |

#### 3.4.2 Redis å­˜å‚¨ç»“æ„

| Key æ ¼å¼ | æ•°æ®ç»“æ„ | è¯´æ˜ |
|----------|----------|------|
| `conversations:messages:pending-input:{conversationId}` | ZSET | å¾…å¤„ç†è¾“å…¥æ¶ˆæ¯ï¼Œscore=æ—¶é—´æˆ³ |
| `conversation:lock:{conversationId}` | STRING | ä¼šè¯çº§åˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢å¹¶å‘å¤„ç† |
| `conversations:queue:{type}-last:{conversationId}` | STRING | æœ€åäº‹ä»¶IDï¼Œç”¨äºé˜²æŠ–åˆ¤æ–­ |

#### 3.4.3 æ ¸å¿ƒ DTO å®šä¹‰

**ä¼šè¯æ•°æ® (ConversationData)**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| conversationId | string | ä¼šè¯å”¯ä¸€ID |
| appId | int | åº”ç”¨ID |
| channelId | int | æ¸ é“ID |
| channelAppId | string? | æ¸ é“åº”ç”¨ID |
| channelConversationId | string? | æ¸ é“ä¼šè¯ID |
| agentConversationId | string? | æ™ºèƒ½ä½“ä¼šè¯ID |
| user | UserInterface? | ç”¨æˆ·ä¿¡æ¯ |
| status | ConversationStatus | ä¼šè¯çŠ¶æ€ (Pendingå¾…å¤„ç†/Agentingæ™ºèƒ½ä½“å¤„ç†ä¸­/Queuingäººå·¥æ’é˜Ÿä¸­/Humanäººå·¥æ¥å¾…/Closedå·²ç»“æŸ) |

**æ ¸å¿ƒæ¶ˆæ¯ (Message)**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| messageId | string? | å†…éƒ¨æ¶ˆæ¯ID |
| conversationId | string? | å†…éƒ¨ä¼šè¯ID |
| chatId | string? | å†…éƒ¨å¯¹è¯ID |
| sender | UserInterface? | å‘é€è€…ä¿¡æ¯ |
| messageType | MessageType | æ¶ˆæ¯ç±»å‹ (Chat/Event) |
| contentType | ContentType | å†…å®¹ç±»å‹ (Text/Image/Voice/Video/File/Event/Markdown) |
| content | array? | æ¶ˆæ¯å†…å®¹ |
| timestamp | int | æ—¶é—´æˆ³ |
| rawData | string? | åŸå§‹æ•°æ® |

**æ¸ é“æ¶ˆæ¯ (ChannelMessage)**ï¼šç»§æ‰¿ Message

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| appId | int? | åº”ç”¨ID |
| channelId | int? | æ¸ é“ID |
| channelAppId | string? | æ¸ é“åº”ç”¨ID |
| channelConversationId | string? | æ¸ é“ä¼šè¯ID |
| channelChatId | string? | æ¸ é“èŠå¤©ID |
| channelMessageId | string? | æ¸ é“æ¶ˆæ¯ID |

**æ™ºèƒ½ä½“æ¶ˆæ¯ (AgentMessage)**ï¼šç»§æ‰¿ Message

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| agentId | int? | æ™ºèƒ½ä½“ID |
| agentConversationId | string? | æ™ºèƒ½ä½“ä¼šè¯ID |
| agentChatId | string? | æ™ºèƒ½ä½“èŠå¤©ID |
| agentMessageId | string? | æ™ºèƒ½ä½“æ¶ˆæ¯ID |

**ä¼šè¯äº‹ä»¶ (ConversationEvent)**ï¼šç”¨äºé˜Ÿåˆ—æ¶ˆæ¯

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | string | äº‹ä»¶å”¯ä¸€ID (UUID) |
| conversationId | string | ä¼šè¯ID |
| queue | ConversationQueueType | é˜Ÿåˆ—ç±»å‹ (Inputs/Outputs/Callback) |
| timestamp | int | æ—¶é—´æˆ³ |
| delaySeconds | int? | å»¶æ—¶ç§’æ•°ï¼ˆç”¨äºé˜²æŠ–ï¼‰ |

**è¾“å‡ºé˜Ÿåˆ—æ¶ˆæ¯ (ConversationOutputQueue)**ï¼šç»§æ‰¿ ConversationData

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| messages | ChannelMessage[] | å¾…å‘é€çš„æ¶ˆæ¯åˆ—è¡¨ |



#### 3.4.4 MQ æŠ½è±¡æ¥å£ (ConversationQueueInterface)

æ¶ˆæ¯é˜Ÿåˆ—æ¥å£å®šä¹‰ï¼Œæ”¯æŒå¤šç§å®ç°ï¼š

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `publish(ConversationQueueType $queueType, Data $message, ?int $delaySeconds = null): void` | å‘å¸ƒæ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œæ”¯æŒå»¶æ—¶å‘å¸ƒ |
| `subscribe(ConversationQueueType $queueType, callable $callback): void` | è®¢é˜…é˜Ÿåˆ—æ¶ˆæ¯ |
| `ack(mixed $message): void` | ç¡®è®¤æ¶ˆæ¯æ¶ˆè´¹ |
| `nack(mixed $message): void` | æ‹’ç»æ¶ˆæ¯ï¼Œé‡æ–°å…¥é˜Ÿ |
| `isLastEvent(ConversationEvent $event): bool` | åˆ¤æ–­æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªäº‹ä»¶ï¼ˆç”¨äºé˜²æŠ–ï¼‰ |
| `recordLastEvent(ConversationEvent $event): void` | è®°å½•æœ€åä¸€æ¬¡äº‹ä»¶ID |

**å®ç°ç±»**ï¼š
- `RedisQueue` - Redis List å®ç°
- `RedisStreamQueue` - Redis Streams å®ç°

---

## 4. åŠŸèƒ½éœ€æ±‚

### 4.1 æ¸ é“æ¥å…¥å±‚ (Channel)

#### 4.1.1 æ¦‚è¿°

æ¸ é“æ¥å…¥å±‚æ˜¯ç³»ç»Ÿçš„å…¥å£å’Œå‡ºå£ï¼Œè´Ÿè´£ä¸å„å®¢æœæ¸ é“çš„ç›´æ¥äº¤äº’ã€‚

#### 4.1.2 æ ¸å¿ƒèŒè´£

| èŒè´£ | è¯´æ˜ |
|------|------|
| **æ¸ é“å›è°ƒæ¥æ”¶** | æ¥æ”¶å„æ¸ é“æ¨é€çš„å®¢æœæ¶ˆæ¯ |
| **ç­¾åéªŒè¯** | éªŒè¯æ¸ é“è¯·æ±‚çš„åˆæ³•æ€§ |
| **æ¶ˆæ¯æ ¼å¼è½¬æ¢** | å°†æ¸ é“æ¶ˆæ¯è½¬ä¸ºç»Ÿä¸€æ ¼å¼ (ChannelMessage) |
| **æ¶ˆæ¯å…¥é˜Ÿ** | å‘å¸ƒäº‹ä»¶åˆ° inputs é˜Ÿåˆ— |
| **æ¶ˆè´¹ outputs** | æ¶ˆè´¹è¾“å‡ºé˜Ÿåˆ—ï¼Œæ‰§è¡Œæ¶ˆæ¯å‘é€ |
| **æ¶ˆæ¯å‘é€** | è°ƒç”¨æ¸ é“APIå‘é€å›å¤æ¶ˆæ¯ |
| **è½¬äººå·¥æ‰§è¡Œ** | è°ƒç”¨æ¸ é“è½¬äººå·¥API |

#### 4.1.3 æ”¯æŒæ¸ é“

- ä¼ä¸šå¾®ä¿¡å®¢æœ
- æ·˜å®/å¤©çŒ«å®¢æœ
- æŠ–éŸ³å®¢æœ
- è‡ªå®šä¹‰ API

#### 4.1.4 æ¸ é“é€‚é…å™¨æ¥å£ (ChannelAdapterInterface)

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `verifySignature()` | éªŒè¯ç­¾å |
| `extractCallbackPayload()` | æå–å›è°ƒè½½è· |
| `parseMessages()` | è§£ææ¶ˆæ¯ |
| `convertToChannelFormat()` | è½¬æ¢ä¸ºæ¸ é“æ ¼å¼ |
| `sendMessages()` | å‘é€æ¶ˆæ¯åˆ°æ¸ é“ |
| `transferToHumanQueuing()` | è½¬äººå·¥æ’é˜Ÿ |
| `health()` | å¥åº·æ£€æŸ¥ |

#### 4.1.5 å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant C as å®¢æœæ¸ é“
    participant CH as æ¸ é“æ¥å…¥å±‚
    participant IQ as inputsé˜Ÿåˆ—
    participant OQ as outputsé˜Ÿåˆ—

    Note over C,OQ: å…¥ç«™æµç¨‹
    C->>CH: æ¸ é“å›è°ƒ
    CH->>CH: éªŒç­¾ + æ ¼å¼è½¬æ¢
    CH->>IQ: å‘å¸ƒåˆ° inputs é˜Ÿåˆ—
    CH-->>C: å¿«é€Ÿå“åº”

    Note over C,OQ: å‡ºç«™æµç¨‹
    OQ->>CH: æ¶ˆè´¹ outputs æ¶ˆæ¯
    
    alt å›å¤æ¶ˆæ¯
        CH->>C: å‘é€å›å¤
    else è½¬äººå·¥
        CH->>C: è°ƒç”¨è½¬äººå·¥API
    else å…³é—­ä¼šè¯
        CH->>C: è°ƒç”¨å…³é—­API
    end
```

---

### 4.2 æ¶ˆæ¯å¤„ç†å¼•æ“ (Engine)

#### 4.2.1 æ¦‚è¿°

æ¶ˆæ¯å¤„ç†å¼•æ“æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒå¤„ç†å±‚ï¼Œè´Ÿè´£æ¶ˆæ¯çš„é˜²æŠ–èšåˆã€é¢„æ ¡éªŒã€æ™ºèƒ½ä½“è°ƒç”¨å’Œç»“æœå‘å¸ƒã€‚

#### 4.2.2 æ ¸å¿ƒèŒè´£

| èŒè´£ | è¯´æ˜ |
|------|------|
| **æ¶ˆè´¹ inputs é˜Ÿåˆ—** | æ¥æ”¶æ¸ é“å±‚å‘å¸ƒçš„æ¶ˆæ¯äº‹ä»¶ |
| **é˜²æŠ–å¤„ç†** | èšåˆåŒä¸€ä¼šè¯çš„è¿ç»­æ¶ˆæ¯ |
| **ä¼šè¯é”ç®¡ç†** | é˜²æ­¢å¹¶å‘å¤„ç†åŒä¸€ä¼šè¯ |
| **é¢„æ ¡éªŒ** | è§„åˆ™é¢„åˆ¤æ–­ï¼ˆå…³é”®è¯è½¬äººå·¥ç­‰ï¼‰ |
| **æ™ºèƒ½ä½“è°ƒç”¨** | è°ƒç”¨æ™ºèƒ½ä½“è·å–å›å¤ |
| **å‘å¸ƒ outputs** | å°†å¤„ç†ç»“æœå‘å¸ƒåˆ°è¾“å‡ºé˜Ÿåˆ— |

#### 4.2.3 æ ¸å¿ƒæœåŠ¡

| æœåŠ¡ | è¯´æ˜ |
|------|------|
| **EngineCoreService** | ä¼šè¯äº‹ä»¶å¤„ç†æ ¸å¿ƒæœåŠ¡ |
| **PreCheckService** | æ¶ˆæ¯é¢„æ ¡éªŒæœåŠ¡ï¼ˆçŠ¶æ€æ£€æŸ¥ã€å…³é”®è¯åŒ¹é…ï¼‰ |
| **AgentApplicationService** | æ™ºèƒ½ä½“è°ƒç”¨æœåŠ¡ |
| **ConversationApplicationService** | ä¼šè¯ç®¡ç†æœåŠ¡ |

#### 4.2.4 é¢„æ ¡éªŒåŠ¨ä½œç±»å‹ (ActionType)

| åŠ¨ä½œ | è¯´æ˜ |
|------|------|
| `Continue` | ç»§ç»­å¤„ç†ï¼Œè°ƒç”¨æ™ºèƒ½ä½“ |
| `Ignore` | å¿½ç•¥å¤„ç†ï¼ˆä¼šè¯å·²è½¬äººå·¥/å·²å…³é—­ï¼‰ |
| `TransferHuman` | è§¦å‘è½¬äººå·¥ï¼ˆå…³é”®è¯å‘½ä¸­ç­‰ï¼‰ |

#### 4.2.5 å¤„ç†æµç¨‹

```mermaid
flowchart TD
    A["æ¶ˆè´¹ inputs é˜Ÿåˆ—"] --> B["è·å–ä¼šè¯é”"]
    B --> C{è·å–é”æˆåŠŸ?}
    C -->|å¦| D["ç¨åé‡è¯•"]
    C -->|æ˜¯| E["é˜²æŠ–åˆ¤æ–­"]
    
    E --> F{æ˜¯æœ€åäº‹ä»¶?}
    F -->|å¦| G["è·³è¿‡å¤„ç†"]
    F -->|æ˜¯| H["è·å–å¾…å¤„ç†æ¶ˆæ¯"]
    
    H --> I["é¢„æ ¡éªŒ PreCheck"]
    
    I --> J{é¢„æ ¡éªŒç»“æœ}
    J -->|Ignore| K["è·³è¿‡å¤„ç†"]
    J -->|TransferHuman| L["å‘å¸ƒè½¬äººå·¥åˆ° outputs"]
    J -->|Continue| M["è°ƒç”¨æ™ºèƒ½ä½“"]
    
    M --> N{æ™ºèƒ½ä½“å“åº”}
    N -->|æˆåŠŸ| O["å‘å¸ƒå›å¤åˆ° outputs"]
    N -->|å»ºè®®è½¬äººå·¥| L
    N -->|å¤±è´¥| P["å…œåº•å¤„ç†"]
    
    P --> Q{æœ‰é™çº§æ™ºèƒ½ä½“?}
    Q -->|æ˜¯| M
    Q -->|å¦| L
    
    K --> R["é‡Šæ”¾é”"]
    L --> R
    O --> R
    R --> S["ç¡®è®¤æ¶ˆè´¹"]
```

---

### 4.3 æ™ºèƒ½ä½“æ¥å…¥å±‚ (Agent)

#### 4.3.1 æ¦‚è¿°

æ™ºèƒ½ä½“æ¥å…¥å±‚è´Ÿè´£å¯¹æ¥å„ç§ AI å¹³å°ï¼Œæä¾›ç»Ÿä¸€çš„æ™ºèƒ½ä½“è°ƒç”¨æ¥å£ã€‚

#### 4.3.2 æ ¸å¿ƒèŒè´£

| èŒè´£ | è¯´æ˜ |
|------|------|
| **ç»Ÿä¸€æ¥å£** | æä¾› AgentAdapterInterface ç»Ÿä¸€æ¥å£ |
| **å¤šå¹³å°å¯¹æ¥** | æ”¯æŒ OpenAIã€é€šä¹‰åƒé—®ã€Cozeã€Dify ç­‰å¹³å° |
| **æ¶ˆæ¯è½¬æ¢** | å°†ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼è½¬ä¸ºå¹³å°ç‰¹å®šæ ¼å¼ |
| **å“åº”è§£æ** | å°†å¹³å°å“åº”è½¬ä¸ºç»Ÿä¸€çš„ AgentMessage |

#### 4.3.3 æ™ºèƒ½ä½“é€‚é…å™¨æ¥å£ (AgentAdapterInterface)

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `initialize(config)` | åˆå§‹åŒ–æ™ºèƒ½ä½“é…ç½® |
| `chat(request)` | å‘é€æ¶ˆæ¯å¹¶è·å–å›å¤ |
| `healthCheck()` | å¥åº·æ£€æŸ¥ |

#### 4.3.4 æ”¯æŒå¹³å°

| å¹³å° | è¯´æ˜ |
|------|------|
| **Coze** | å­—èŠ‚è·³åŠ¨æ™ºèƒ½ä½“å¹³å°ï¼ˆå·²å®ç°ï¼‰ |
| **OpenAI** | GPT-4, GPT-3.5 |
| **é€šä¹‰åƒé—®** | é˜¿é‡Œäº‘å¤§æ¨¡å‹ |
| **Dify** | å¼€æºLLMåº”ç”¨å¹³å° |

#### 4.3.5 å¤„ç†æµç¨‹

```mermaid
flowchart LR
    subgraph Engine["æ¶ˆæ¯å¤„ç†å¼•æ“"]
        Request["AgentMessage[]"]
    end
    
    subgraph AgentLayer["æ™ºèƒ½ä½“æ¥å…¥å±‚"]
        Service["AgentApplicationService"]
        Factory["AdapterFactory"]
        Adapter["AgentAdapter"]
    end
    
    subgraph Platforms["AI å¹³å°"]
        Coze["Coze"]
        OpenAI["OpenAI"]
        Qwen["é€šä¹‰åƒé—®"]
        Dify["Dify"]
    end
    
    Request --> Service
    Service --> Factory
    Factory --> Adapter
    Adapter --> Platforms
    Platforms --> Adapter
    Adapter --> Service
    Service --> Response["AgentMessage[]"]
```

---

### 4.4 ä¼šè¯ç®¡ç†

#### 4.4.1 ä¼šè¯çŠ¶æ€

| çŠ¶æ€ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| **å¾…å¤„ç†** | Pending | æ–°ä¼šè¯ï¼Œç­‰å¾…å¤„ç† |
| **æ™ºèƒ½ä½“å¤„ç†ä¸­** | Agenting | æ™ºèƒ½ä½“æ­£åœ¨å¤„ç† |
| **äººå·¥æ’é˜Ÿä¸­** | Queuing | ç­‰å¾…äººå·¥æ¥å…¥ |
| **äººå·¥æ¥å¾…** | Human | äººå·¥å®¢æœå¤„ç†ä¸­ |
| **å·²ç»“æŸ** | Closed | ä¼šè¯å·²å…³é—­ |

#### 4.4.2 çŠ¶æ€æµè½¬

```mermaid
stateDiagram-v2
    [*] --> Pending: ç”¨æˆ·å‘èµ·ä¼šè¯
    
    Pending --> Agenting: å¼€å§‹æ™ºèƒ½ä½“å¤„ç†
   
    
    Pending --> Queuing: è§¦å‘è½¬äººå·¥
    Agenting --> Queuing: æ™ºèƒ½ä½“å»ºè®®è½¬äººå·¥
    
    Queuing --> Human: äººå·¥å®¢æœæ¥å…¥
    Human --> Closed: äººå·¥ç»“æŸä¼šè¯
    
    Pending --> Closed: è¶…æ—¶å…³é—­
    Agenting --> Closed: è¶…æ—¶å…³é—­
    
    Closed --> [*]
```

---

### 4.5 ç®¡ç†ç«¯ (Admin)

#### 4.5.1 æ¦‚è¿°

ç®¡ç†ç«¯æä¾›å¯è§†åŒ–çš„é…ç½®ç®¡ç†å’Œæ•°æ®ç»Ÿè®¡åŠŸèƒ½ï¼ŒåŸºäº Filament æ„å»ºã€‚

#### 4.5.2 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | è¯´æ˜ |
|----------|------|
| **åº”ç”¨ç®¡ç†** | åˆ›å»ºå’Œç®¡ç†å®¢æœåº”ç”¨ |
| **æ¸ é“é…ç½®** | é…ç½®å„æ¸ é“çš„æ¥å…¥å‚æ•° |
| **æ™ºèƒ½ä½“é…ç½®** | é…ç½®æ™ºèƒ½ä½“ç±»å‹å’Œå‚æ•° |
| **ä¼šè¯æŸ¥çœ‹** | æŸ¥çœ‹ä¼šè¯è®°å½•å’Œæ¶ˆæ¯è¯¦æƒ… |
| **æ•°æ®ç»Ÿè®¡** | æ¶ˆæ¯é‡ã€ä¼šè¯é‡ã€è½¬äººå·¥ç‡ç­‰ç»Ÿè®¡ |

---

---

## 5. æ•°æ®æ¨¡å‹

### 5.1 å®ä½“å…³ç³»å›¾

```mermaid
erDiagram
    AGENT ||--o{ CHANNEL : "ç»‘å®š"
    CHANNEL ||--o{ CONVERSATION : "äº§ç”Ÿ"
    CONVERSATION ||--o{ MESSAGE : "åŒ…å«"

    AGENT {
        bigint id PK
        varchar owner_type
        varchar owner_id
        varchar name
        varchar agent_type
        varchar provider
        json config
        tinyint status
    }

    CHANNEL {
        bigint id PK
        bigint app_id FK
        bigint agent_id FK
        varchar channel
        json config
        tinyint status
    }

    CONVERSATION {
        bigint id PK
        varchar conversation_id UK
        varchar agent_conversation_id
        varchar channel_conversation_id
        bigint app_id FK
        bigint channel_id FK
        bigint agent_id FK
        varchar user_type
        varchar user_id
        varchar status
        json context
    }

    MESSAGE {
        bigint id PK
        varchar message_id UK
        varchar conversation_id FK
        varchar chat_id
        bigint app_id FK
        bigint channel_id FK
        bigint agent_id FK
        varchar message_type
        varchar content_type
        json content
        bigint timestamp
    }
```

### 5.2 æ ¸å¿ƒå®ä½“

#### æ™ºèƒ½ä½“è¡¨ (agents)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| owner_type | varchar(32) | æ‰€å±è€…ç±»å‹ |
| owner_id | varchar(64) | æ‰€å±è€…ID |
| name | varchar(100) | æ™ºèƒ½ä½“åç§° |
| agent_type | varchar(20) | æ™ºèƒ½ä½“ç±»å‹ |
| provider | varchar(20) | æä¾›è€… |
| config | json | é…ç½®ä¿¡æ¯ |
| status | tinyint | çŠ¶æ€ |

#### æ¸ é“è¡¨ (channels)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| app_id | bigint | åº”ç”¨ID |
| agent_id | bigint | ç»‘å®šçš„æ™ºèƒ½ä½“ID |
| channel | varchar(20) | æ¸ é“ç±»å‹ |
| config | json | é…ç½®ä¿¡æ¯ |
| status | tinyint | çŠ¶æ€ |

#### ä¼šè¯è¡¨ (conversations)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| conversation_id | varchar(64) | ä¼šè¯IDï¼ˆç³»ç»Ÿç”Ÿæˆï¼‰ |
| agent_conversation_id | varchar(128) | æ™ºèƒ½ä½“ä¼šè¯ID |
| channel_conversation_id | varchar(128) | æ¸ é“ä¼šè¯ID |
| channel_app_id | varchar(128) | æ¸ é“åº”ç”¨ID |
| app_id | bigint | åº”ç”¨ID |
| channel_id | bigint | æ¸ é“ID |
| agent_id | bigint | æ™ºèƒ½ä½“ID |
| user_type | varchar(32) | ç”¨æˆ·ç±»å‹ |
| user_id | varchar(64) | ç”¨æˆ·ID |
| user_nickname | varchar(64) | ç”¨æˆ·æ˜µç§° |
| status | varchar(20) | ä¼šè¯çŠ¶æ€ |
| context | json | ä¸Šä¸‹æ–‡æ•°æ® |
| transfer_reason | varchar(100) | è½¬æ¥åŸå›  |
| transfer_source | varchar(20) | è½¬æ¥æ¥æº |
| servicer | varchar(64) | å®¢æœ |

#### æ¶ˆæ¯è¡¨ (messages)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| message_id | varchar(64) | æ¶ˆæ¯IDï¼ˆç³»ç»Ÿç”Ÿæˆï¼‰ |
| conversation_id | varchar(64) | ä¼šè¯ID |
| chat_id | varchar(64) | å¯¹è¯ID |
| app_id | bigint | åº”ç”¨ID |
| message_type | varchar(32) | æ¶ˆæ¯ç±»å‹ |
| content_type | varchar(32) | å†…å®¹ç±»å‹ |
| content | json | æ¶ˆæ¯å†…å®¹ |
| sender_type | varchar(32) | å‘é€è€…ç±»å‹ |
| sender_id | varchar(128) | å‘é€è€…ID |
| channel_id | bigint | æ¸ é“ID |
| channel_message_id | varchar(128) | æ¸ é“æ¶ˆæ¯ID |
| agent_id | bigint | æ™ºèƒ½ä½“ID |
| agent_message_id | bigint | æ™ºèƒ½ä½“æ¶ˆæ¯ID |
| timestamp | bigint | æ¶ˆæ¯æ—¶é—´æˆ³ |

---

## 6. é™„å½•

### 9.1 å‚è€ƒæ–‡æ¡£

**æ¸ é“å¯¹æ¥**ï¼š
- [ä¼ä¸šå¾®ä¿¡å®¢æœAPIæ–‡æ¡£](https://developer.work.weixin.qq.com/document/path/94638)
- [æ·˜å®å¼€æ”¾å¹³å°æ–‡æ¡£](https://open.taobao.com/)

**è¿œç¨‹æ™ºèƒ½ä½“**ï¼š
- [OpenAI APIæ–‡æ¡£](https://platform.openai.com/docs/)
- [é€šä¹‰åƒé—®APIæ–‡æ¡£](https://help.aliyun.com/document_detail/2400395.html)
- [Cozeå¼€æ”¾å¹³å°æ–‡æ¡£](https://www.coze.cn/docs/)
- [Difyæ–‡æ¡£](https://docs.dify.ai/)

**æœ¬åœ°æ¨¡å‹**ï¼š
- [Ollamaå®˜æ–¹æ–‡æ¡£](https://ollama.ai/)
- [llama.cppé¡¹ç›®](https://github.com/ggerganov/llama.cpp)
- [vLLMæ–‡æ¡£](https://docs.vllm.ai/)

